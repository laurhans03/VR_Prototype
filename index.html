<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mein VR-Prototyp</title>

    <!-- Load the A-Frame framework for building WebVR scenes -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
</head>

<body>
    <!-- Display a loading message before the scene is fully initialized -->
    <div id="loading">Loading scene...</div>


    <!-- Main VR scene container -->
    <a-scene adjust-avatar>
        <!-- Video assets -->
        <a-assets>
            <img id="menu_img" src="media/menu.png">
            <a-asset-item id="avatarModel" src="models/man_sitting.glb"></a-asset-item>
        </a-assets>

        <!-- Kamera: unabhÃ¤ngig vom Avatar, wird vom Headset gesteuert -->
        <a-entity id="cameraRig" position="0 0 0">
            <a-entity id="camera" camera look-controls wasd-controls="enabled: false" raycaster="objects: .clickable">
                     
                <a-entity id="cursorBase" cursor="fuse: true; fuseTimeout: 2000" position="0 0 -0.5"
                        geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                        material="color: transparent; shader: flat">
            </a-entity>

            <a-ring id="progressRing" radius-inner="0.011" radius-outer="0.02" position="0 0 -0.5" color="#FFD700"
                    theta-start="0" theta-length="0">
            </a-ring>
            </a-entity>
        </a-entity>


           <!-- Menu 1 -->
        <a-entity id="menu" visible="true">
            <a-videosphere src="#menu_img" rotation="0 -102 0"></a-videosphere>
              <!-- Display a welcome message floating in front of the user -->
                <a-text value="Welcome!" align="center" position="0 1.5 -2" color="#ffffff" width="3"></a-text>
        </a-entity> 

        <a-entity id="rooms" visible="false">
            <!-- Avatar sichtbar nur hier -->
           <a-entity id="avatarAnchor">
                <a-entity id="avatarWrapper" hide-avatar-behind rotation="0 -45 0">
                    <a-entity id="avatar" gltf-model="#avatarModel"
                        position="-2 -1.3 0.27"
                        rotation="0 0 0"
                        scale="1 1 1">
                    </a-entity>
                </a-entity>
            </a-entity>

            <a-plane id="returnZone"
                position="0 3 0"
                rotation="90 0 0"
                width="4"
                height="4"
                material="color: #00ff00; opacity: 0; transparent: true"
                class="clickable"
                visible="false">
            </a-plane>


            <!-- RÃ¤ume werden dynamisch erzeugt -->
        </a-entity>

   

        <!-- Enable hand tracking for left and right hands -->
        <a-entity id="leftHand" hand-tracking-controls="hand: left"></a-entity>
        <a-entity id="rightHand" hand-tracking-controls="hand: right"></a-entity>


    </a-scene>

<script>
    //Avatarpositionierung
    AFRAME.registerComponent('adjust-avatar', {
        tick: function () {
            const camera = document.querySelector('#camera');
            const anchor = document.querySelector('#avatarAnchor');
            const rooms = document.querySelector('#rooms');
            if (!camera || !anchor || !rooms) return;
            if (!rooms.getAttribute('visible')) return;

            const camPos = camera.object3D.position;
            anchor.object3D.position.copy(camPos);
        }
        });


       


    //MenÃ¼ anzeigen
    function showMenu() {
  const menu = document.querySelector('#menu');
  const rooms = document.querySelector('#rooms');
  const cursorBase = document.querySelector('#cursorBase');
  const progressRing = document.querySelector('#progressRing');
  const returnZone = document.querySelector('#returnZone');

  menu.setAttribute('visible', true);
  rooms.setAttribute('visible', false);
  cursorBase.object3D.visible = true;
  progressRing.object3D.visible = true;
  progressRing.setAttribute('theta-length', 0);
  returnZone.setAttribute('visible', false);

  // RÃ¤ume bereinigen
  rooms.querySelectorAll('.room').forEach(r => r.remove());

  // Icons wieder aktivieren
  menu.querySelectorAll('[id^="to-"]').forEach(el => {
    el.setAttribute('visible', true);
    el.classList.add('clickable');
  });
}


//Raum anzeigen
function showRooms() {
  const menu = document.querySelector('#menu');
  const rooms = document.querySelector('#rooms');
  const cursorBase = document.querySelector('#cursorBase');
  const progressRing = document.querySelector('#progressRing');
  const returnZone = document.querySelector('#returnZone');

  menu.setAttribute('visible', false);
  rooms.setAttribute('visible', true);
  cursorBase.object3D.visible = false;
  progressRing.object3D.visible = false;
  returnZone.setAttribute('visible', true);
}



//JSON laden und Icons erzeugen
document.querySelector('a-scene').addEventListener('loaded', async () => {
  const response = await fetch('videos.json');
  const data = await response.json();

  const menu = document.querySelector('#menu');
  const assets = document.querySelector('a-assets');
  const rooms = document.querySelector('#rooms');
  const progressRing = document.querySelector('#progressRing');
  const cursorBase = document.querySelector('#cursorBase');
  const returnZone = document.querySelector('#returnZone');

  // ðŸ”¹ Video-Assets vorbereiten
 // ðŸ”¹ Video-Assets vorbereiten
data.videos.forEach((video) => {
  const videoEl = document.createElement('video');
  videoEl.id = video.id;
  videoEl.src = video.src;
  videoEl.setAttribute('preload', 'auto');
  videoEl.setAttribute('autoplay', 'true');
  videoEl.setAttribute('loop', 'true');
  videoEl.setAttribute('muted', 'true');
  videoEl.setAttribute('playsinline', 'true'); // Wichtig fÃ¼r Quest!
  videoEl.setAttribute('webkit-playsinline', 'true'); // iOS/Meta Compat
  videoEl.crossOrigin = 'anonymous';

  // Autoplay-Fix fÃ¼r VR: erst starten, wenn User klickt
  videoEl.addEventListener('loadeddata', () => {
    videoEl.play().catch(() => {
      console.log("Autoplay blockiert â€“ wird spÃ¤ter per Interaktion gestartet.");
    });
  });

  assets.appendChild(videoEl);
});


  // ðŸ”¹ MenÃ¼-Icons erzeugen (bogenfÃ¶rmig, versetzt)
  const total = data.videos.length;
  const maxRows = 4;
  const radius = 3.2;
  const horizontalSpread = 60;
  const verticalSpread = 0.8;

  const rows = Math.min(maxRows, Math.ceil(total / 3));
  const itemsPerRow = Math.ceil(total / rows);
  const totalHeight = (rows - 1) * verticalSpread;
  const baseY = totalHeight / 2;

  let videoIndex = 0;
  let prevAngles = null;

  for (let row = 0; row < rows; row++) {
    const remaining = total - videoIndex;
    const count = Math.min(itemsPerRow, remaining);
    if (count <= 0) break;

    const y = baseY - row * verticalSpread;
    let angles = [];

    if (prevAngles && count < prevAngles.length) {
      const midpoints = [];
      for (let i = 0; i < prevAngles.length - 1; i++) {
        midpoints.push((prevAngles[i] + prevAngles[i + 1]) / 2);
      }

      if (count === midpoints.length) {
        angles = midpoints.slice();
      } else if (count === 1) {
        angles = [midpoints[Math.floor(midpoints.length / 2)]];
      } else {
        for (let k = 0; k < count; k++) {
          const idx = Math.round(k * (midpoints.length - 1) / (count - 1));
          angles.push(midpoints[idx]);
        }
      }
    } else {
      const span = (count > 1) ? (horizontalSpread / (count - 1)) : 0;
      const start = -horizontalSpread / 2;
      for (let i = 0; i < count; i++) {
        angles.push(start + i * span);
      }
    }

    for (let i = 0; i < angles.length; i++) {
      if (videoIndex >= total) break;
      const video = data.videos[videoIndex++];

      const yawDeg = angles[i];
      const yawRad = THREE.MathUtils.degToRad(yawDeg);
      const x = radius * Math.sin(yawRad);
      const z = -radius * Math.cos(yawRad);

      const entry = document.createElement('a-entity');
      entry.classList.add('clickable', 'menu-entry');
      entry.id = `to-${video.id}`;
      entry.setAttribute('position', `${x} ${y} ${z}`);
      entry.setAttribute('look-at', '[camera]');
      entry.setAttribute('visible', true);

      const icon = document.createElement('a-image');
      icon.setAttribute('src', 'media/videoicon.png');
      icon.setAttribute('width', '0.45');
      icon.setAttribute('height', '0.45');
      icon.setAttribute('material', 'color: white; opacity: 0.9');
      entry.appendChild(icon);

      const text = document.createElement('a-text');
      text.setAttribute('value', video.title);
      text.setAttribute('align', 'center');
      text.setAttribute('position', '0 -0.35 0');
      text.setAttribute('width', '2');
      text.setAttribute('color', 'white');
      entry.appendChild(text);

      menu.appendChild(entry);

      // ðŸ”¹ Interaktion
      entry.addEventListener('mouseenter', () => {
        progressRing.removeAttribute('animation__fill');
        progressRing.setAttribute('animation__fill',
          'property: theta-length; from: 0; to: 360; dur: 2000; easing: linear');
      });

      entry.addEventListener('mouseleave', () => {
        progressRing.removeAttribute('animation__fill');
        progressRing.setAttribute('theta-length', 0);
      });

     entry.addEventListener('click', () => {
        showRooms();

        let room = document.querySelector(`#${video.id}`);
        if (!room) {
            room = document.createElement('a-entity');
            room.id = video.id;
            room.classList.add('room');

            const sphere = document.createElement('a-videosphere');
            sphere.setAttribute('src', `#${video.id}`);
            room.appendChild(sphere);
            rooms.appendChild(room);
        } else {
            room.setAttribute('visible', 'true');
        }

        cursorBase.object3D.visible = false;
        progressRing.object3D.visible = false;

        returnZone.object3D.position.set(0, 2, -1);
        returnZone.setAttribute('visible', true);

        // ðŸ”¹ **WICHTIG: Video sicher aktivieren**
        const videoEl = document.querySelector(`#${video.id}`);
        if (videoEl) {
            videoEl.setAttribute('muted', 'true');
            videoEl.setAttribute('playsinline', 'true');
            videoEl.setAttribute('webkit-playsinline', 'true');
            videoEl.play().catch(err => console.warn("Video start blockiert:", err));
        }
        });

    }

    prevAngles = angles.slice();
  }

  document.getElementById('loading').style.display = 'none';

  // ðŸ”¹ RÃ¼ckkehrflÃ¤che aktivieren
  if (returnZone) {
    let returnTimer = null;

    returnZone.addEventListener('mouseenter', () => {
      cursorBase.object3D.visible = true;
      progressRing.object3D.visible = true;
      progressRing.removeAttribute('animation__fill');
      progressRing.setAttribute('animation__fill',
        'property: theta-length; from: 0; to: 360; dur: 5000; easing: linear');

      returnTimer = setTimeout(() => {
        showMenu();
        progressRing.removeAttribute('animation__fill');
        progressRing.setAttribute('theta-length', 0);
      }, 5000);
    });

    returnZone.addEventListener('mouseleave', () => {
      cursorBase.object3D.visible = false;
      progressRing.object3D.visible = false;
      progressRing.removeAttribute('animation__fill');
      progressRing.setAttribute('theta-length', 0);
      clearTimeout(returnTimer);
      returnTimer = null;
    });
  }
});
</script>



   <!-- <script>
        AFRAME.registerComponent('adjust-avatar', {
        tick: function () {
            const camera = document.querySelector('#camera');
            const anchor = document.querySelector('#avatarAnchor');
            const rooms = document.querySelector('#rooms');
            if (!camera || !anchor || !rooms) return;
            if (!rooms.getAttribute('visible')) return;

            const camPos = camera.object3D.position;
            anchor.object3D.position.copy(camPos);
        }
        });

        AFRAME.registerComponent('room-return', {
        init: function () {
            this.lookTimer = 0;
            this.cursorShown = false;
        },
        tick: function (time, deltaTime) {
            const camera = document.querySelector('#camera');
            const rooms = document.querySelector('#rooms');
            const menu = document.querySelector('#menu');
            const cursorBase = document.querySelector('#cursorBase');
            const progressRing = document.querySelector('#progressRing');
            const entries = document.querySelectorAll('.clickable');

            if (!camera || !rooms || !menu || !cursorBase || !progressRing) return;

            const dir = new THREE.Vector3();
            camera.object3D.getWorldDirection(dir);
            const camPos = camera.object3D.getWorldPosition(new THREE.Vector3());

            const inRoom = rooms.getAttribute('visible');
            const inMenu = menu.getAttribute('visible');

            // ðŸ”¹ Buttons nur aktiv im MenÃ¼
            entries.forEach(el => {
            el.setAttribute('visible', inMenu);
            if (inMenu) {
                el.classList.add('clickable');
            } else {
                el.classList.remove('clickable');
            }
            });

            // ðŸ”¹ Cursor im MenÃ¼ immer sichtbar
            if (inMenu) {
            cursorBase.object3D.visible = true;
            progressRing.object3D.visible = true;
            return;
            }

            // ðŸ”¹ RÃ¼ckblick aktivieren (Kopf nach oben)
            if (inRoom && dir.y > 0.7) {
            this.lookTimer += deltaTime;

            if (!this.cursorShown) {
                // Cursor & Ring sichtbar machen
                cursorBase.object3D.visible = true;
                progressRing.object3D.visible = true;

                // ðŸ”¹ Position 0.5â€¯m in Blickrichtung
                const targetPos = camPos.clone().add(dir.clone().multiplyScalar(0.5));
                cursorBase.object3D.position.copy(targetPos);
                progressRing.object3D.position.copy(targetPos);

                // Ring fÃ¼llen starten
                progressRing.removeAttribute('animation__fill');
                progressRing.setAttribute('animation__fill',
                'property: theta-length; from: 0; to: 360; dur: 3000; easing: linear');

                this.cursorShown = true;
            }

            if (this.lookTimer > 5000) {
                showMenu();
                this.lookTimer = 0;
                this.cursorShown = false;
                progressRing.removeAttribute('animation__fill');
                progressRing.setAttribute('theta-length', 0);
            }
            } else {
            this.lookTimer = 0;
            if (this.cursorShown) {
                cursorBase.object3D.visible = false;
                progressRing.object3D.visible = false;
                progressRing.removeAttribute('animation__fill');
                progressRing.setAttribute('theta-length', 0);
                this.cursorShown = false;
            }
            }
        }
        });


        function showMenu() {
        const menu = document.querySelector('#menu');
        const rooms = document.querySelector('#rooms');
        const cursorBase = document.querySelector('#cursorBase');
        const progressRing = document.querySelector('#progressRing');
        const returnZone = document.querySelector('#returnZone');

        menu.setAttribute('visible', true);
        rooms.setAttribute('visible', false);
        cursorBase.object3D.visible = true;
        progressRing.object3D.visible = true;
        progressRing.setAttribute('theta-length', 0);

        // ðŸ”¹ RÃ¼ckkehrflÃ¤che deaktivieren
        returnZone.setAttribute('visible', false);

        // RÃ¤ume bereinigen
        rooms.querySelectorAll('.room').forEach(r => r.remove());

        menu.querySelectorAll('.clickable').forEach(el => {
            el.setAttribute('visible', true);
            el.classList.add('clickable');
        });
        }


        function showRooms() {
        const menu = document.querySelector('#menu');
        const rooms = document.querySelector('#rooms');
        const cursorBase = document.querySelector('#cursorBase');
        const progressRing = document.querySelector('#progressRing');
        const returnZone = document.querySelector('#returnZone');

        menu.setAttribute('visible', false);
        rooms.setAttribute('visible', true);
        cursorBase.object3D.visible = false;
        progressRing.object3D.visible = false;

        // ðŸ”¹ RÃ¼ckkehrflÃ¤che aktivieren
        returnZone.setAttribute('visible', true);
        }


        /* ===== JSON-LADEN UND SZENE AUFBAUEN ===== */
        document.querySelector('a-scene').addEventListener('loaded', async () => {
            // RÃ¼ckkehr-Zone aktivieren
            const returnZone = document.querySelector('#returnZone');
            if (returnZone) {
            returnZone.addEventListener('click', () => {
                showMenu();
            });
        }

        const response = await fetch('videos.json');
        const data = await response.json();

        const menu = document.querySelector('#menu');
        const assets = document.querySelector('a-assets');
        const rooms = document.querySelector('#rooms');
        const progressRing = document.querySelector('#progressRing');

        data.videos.forEach((video) => {
            // Video-Asset
            const videoEl = document.createElement('video');
            videoEl.id = video.id;
            videoEl.src = video.src;
            videoEl.autoplay = true;
            videoEl.loop = true;
            videoEl.muted = true;
            videoEl.playsInline = true;
            videoEl.crossOrigin = 'anonymous';
            assets.appendChild(videoEl);

            // MenÃ¼-Icon + Text
            const entry = document.createElement('a-entity');
            entry.classList.add('clickable');
            entry.id = `to-${video.id}`;
            entry.setAttribute('visible', true); // explizit sichtbar
            entry.setAttribute('clickable', true); // eigene Klasse

            const [angleYDeg, angleXDeg] = video.position.split(' ').map(Number);
            const radius = 3;
            const angleY = THREE.MathUtils.degToRad(angleYDeg);
            const angleX = THREE.MathUtils.degToRad(angleXDeg);

            const posX = radius * Math.sin(angleY) * Math.cos(angleX);
            const posY = radius * Math.sin(angleX);
            const posZ = -radius * Math.cos(angleY) * Math.cos(angleX);
            entry.setAttribute('position', `${posX} ${posY} ${posZ}`);
            entry.setAttribute('look-at', '[camera]');

            const icon = document.createElement('a-image');
            icon.setAttribute('src', 'media/videoicon.png');
            icon.setAttribute('width', '0.5');
            icon.setAttribute('height', '0.5');
            icon.setAttribute('material', 'color: white; opacity: 0.9');
            entry.appendChild(icon);

            const text = document.createElement('a-text');
            text.setAttribute('value', video.title);
            text.setAttribute('align', 'center');
            text.setAttribute('position', '0 -0.35 0');
            text.setAttribute('width', '2');
            text.setAttribute('color', 'white');
            entry.appendChild(text);

            menu.appendChild(entry);

            // Cursor-Animation
            entry.addEventListener('mouseenter', () => {
            progressRing.removeAttribute('animation__fill');
            progressRing.setAttribute('animation__fill',
                'property: theta-length; from: 0; to: 360; dur: 2000; easing: linear');
            });

            entry.addEventListener('mouseleave', () => {
            progressRing.removeAttribute('animation__fill');
            progressRing.setAttribute('theta-length', 0);
            });

            if (returnZone) {
                returnZone.addEventListener('mouseenter', () => {
                    cursorBase.object3D.visible = true;
                    progressRing.object3D.visible = true;
                    progressRing.removeAttribute('animation__fill');
                    progressRing.setAttribute('animation__fill',
                    'property: theta-length; from: 0; to: 360; dur: 5000; easing: linear');
                });

                returnZone.addEventListener('mouseleave', () => {
                    cursorBase.object3D.visible = false;
                    progressRing.object3D.visible = false;
                    progressRing.removeAttribute('animation__fill');
                    progressRing.setAttribute('theta-length', 0);
                });
                }

            entry.addEventListener('click', () => {
            showRooms();
            const room = document.createElement('a-entity');
            room.classList.add('room');
            room.id = video.id;

            const sphere = document.createElement('a-videosphere');
            sphere.setAttribute('src', `#${video.id}`);
            room.appendChild(sphere);
            rooms.appendChild(room);

            videoEl.play();
            });
        });

        

        document.getElementById('loading').style.display = 'none';
        });
        </script> -->
    </body>
</html>