<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mein VR-Prototyp</title>

    <!-- Load the A-Frame framework for building WebVR scenes -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
</head>

<body>
    <!-- Display a loading message before the scene is fully initialized -->
    <div id="loading">Loading scene...</div>


    <!-- Main VR scene container -->
    <a-scene adjust-avatar room-return>
        <!-- Video assets -->
        <a-assets>
            <img id="menu_img" src="media/menu.png">
            <a-asset-item id="avatarModel" src="models/man_sitting.glb"></a-asset-item>
        </a-assets>

        <!-- Kamera: unabhÃ¤ngig vom Avatar, wird vom Headset gesteuert -->
        <a-entity id="cameraRig" position="0 0 0">
            <a-entity id="camera" camera look-controls wasd-controls="enabled: false" raycaster="objects: .clickable">
                     
                <a-entity id="cursorBase" cursor="fuse: true; fuseTimeout: 2000" position="0 0 -0.5"
                        geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                        material="color: transparent; shader: flat">
            </a-entity>

            <a-ring id="progressRing" radius-inner="0.011" radius-outer="0.02" position="0 0 -0.5" color="#FFD700"
                    theta-start="0" theta-length="0">
            </a-ring>
            </a-entity>
        </a-entity>


           <!-- Menu 1 -->
        <a-entity id="menu" visible="true">
            <a-videosphere src="#menu_img" rotation="0 -102 0"></a-videosphere>
              <!-- Display a welcome message floating in front of the user -->
                <a-text value="Welcome" align="center" position="0 1.5 -2" color="#ffffff" width="3"></a-text>
        </a-entity> 

        <a-entity id="rooms" visible="false">
            <!-- Avatar sichtbar nur hier -->
           <a-entity id="avatarAnchor">
                <a-entity id="avatarWrapper" hide-avatar-behind rotation="0 -45 0">
                    <a-entity id="avatar" gltf-model="#avatarModel"
                        position="-2 -1.3 0.27"
                        rotation="0 0 0"
                        scale="1 1 1">
                    </a-entity>
                </a-entity>
            </a-entity>

            <a-plane id="returnZone"
                position="0 3 0"
                rotation="-90 0 0"
                width="4"
                height="2"
                material="color: red; opacity: 0.5; transparent: true"
                class="clickable">
            </a-plane>


            <!-- RÃ¤ume werden dynamisch erzeugt -->
        </a-entity>

   

        <!-- Enable hand tracking for left and right hands -->
        <a-entity id="leftHand" hand-tracking-controls="hand: left"></a-entity>
        <a-entity id="rightHand" hand-tracking-controls="hand: right"></a-entity>


    </a-scene>

   <script>
AFRAME.registerComponent('adjust-avatar', {
  tick: function () {
    const camera = document.querySelector('#camera');
    const anchor = document.querySelector('#avatarAnchor');
    const rooms = document.querySelector('#rooms');
    if (!camera || !anchor || !rooms) return;
    if (!rooms.getAttribute('visible')) return;

    const camPos = camera.object3D.position;
    anchor.object3D.position.copy(camPos);
  }
});

AFRAME.registerComponent('room-return', {
  init: function () {
    this.lookTimer = 0;
    this.cursorShown = false;
  },
  tick: function (time, deltaTime) {
    const camera = document.querySelector('#camera');
    const rooms = document.querySelector('#rooms');
    const menu = document.querySelector('#menu');
    const cursorBase = document.querySelector('#cursorBase');
    const progressRing = document.querySelector('#progressRing');
    const entries = document.querySelectorAll('.clickable');

    if (!camera || !rooms || !menu || !cursorBase || !progressRing) return;

    const dir = new THREE.Vector3();
    camera.object3D.getWorldDirection(dir);
    const camPos = camera.object3D.getWorldPosition(new THREE.Vector3());

    const inRoom = rooms.getAttribute('visible');
    const inMenu = menu.getAttribute('visible');

    // ðŸ”¹ Buttons nur aktiv im MenÃ¼
    entries.forEach(el => {
      el.setAttribute('visible', inMenu);
      if (inMenu) {
        el.classList.add('clickable');
      } else {
        el.classList.remove('clickable');
      }
    });

    // ðŸ”¹ Cursor im MenÃ¼ immer sichtbar
    if (inMenu) {
      cursorBase.object3D.visible = true;
      progressRing.object3D.visible = true;
      return;
    }

    // ðŸ”¹ RÃ¼ckblick aktivieren (Kopf nach oben)
    if (inRoom && dir.y > 0.7) {
      this.lookTimer += deltaTime;

      if (!this.cursorShown) {
        // Cursor & Ring sichtbar machen
        cursorBase.object3D.visible = true;
        progressRing.object3D.visible = true;

        // ðŸ”¹ Position 0.5â€¯m in Blickrichtung
        const targetPos = camPos.clone().add(dir.clone().multiplyScalar(0.5));
        cursorBase.object3D.position.copy(targetPos);
        progressRing.object3D.position.copy(targetPos);

        // Ring fÃ¼llen starten
        progressRing.removeAttribute('animation__fill');
        progressRing.setAttribute('animation__fill',
          'property: theta-length; from: 0; to: 360; dur: 3000; easing: linear');

        this.cursorShown = true;
      }

      if (this.lookTimer > 3000) {
        showMenu();
        this.lookTimer = 0;
        this.cursorShown = false;
        progressRing.removeAttribute('animation__fill');
        progressRing.setAttribute('theta-length', 0);
      }
    } else {
      this.lookTimer = 0;
      if (this.cursorShown) {
        cursorBase.object3D.visible = false;
        progressRing.object3D.visible = false;
        progressRing.removeAttribute('animation__fill');
        progressRing.setAttribute('theta-length', 0);
        this.cursorShown = false;
      }
    }
  }
});


function showMenu() {
  const menu = document.querySelector('#menu');
  const rooms = document.querySelector('#rooms');
  const cursorBase = document.querySelector('#cursorBase');
  const progressRing = document.querySelector('#progressRing');

  menu.setAttribute('visible', true);
  rooms.setAttribute('visible', false);
  cursorBase.object3D.visible = true;
  progressRing.object3D.visible = true;
  progressRing.setAttribute('theta-length', 0);

  // ðŸ”¹ Buttons wieder aktivieren
  document.querySelectorAll('.clickable').forEach(el => {
    el.setAttribute('visible', true);
    el.classList.add('clickable');
  });

  // RÃ¤ume bereinigen
  rooms.querySelectorAll('.room').forEach(r => r.remove());
}

function showRooms() {
  const menu = document.querySelector('#menu');
  const rooms = document.querySelector('#rooms');
  const cursorBase = document.querySelector('#cursorBase');
  const progressRing = document.querySelector('#progressRing');

  menu.setAttribute('visible', false);
  rooms.setAttribute('visible', true);
  cursorBase.object3D.visible = false;
  progressRing.object3D.visible = false;
}

/* ===== JSON-LADEN UND SZENE AUFBAUEN ===== */
document.querySelector('a-scene').addEventListener('loaded', async () => {
  const response = await fetch('videos.json');
  const data = await response.json();

  const menu = document.querySelector('#menu');
  const assets = document.querySelector('a-assets');
  const rooms = document.querySelector('#rooms');
  const progressRing = document.querySelector('#progressRing');

  data.videos.forEach((video) => {
    // Video-Asset
    const videoEl = document.createElement('video');
    videoEl.id = video.id;
    videoEl.src = video.src;
    videoEl.autoplay = true;
    videoEl.loop = true;
    videoEl.muted = true;
    videoEl.playsInline = true;
    videoEl.crossOrigin = 'anonymous';
    assets.appendChild(videoEl);

    // MenÃ¼-Icon + Text
    const entry = document.createElement('a-entity');
    entry.classList.add('clickable');
    entry.id = `to-${video.id}`;
    entry.setAttribute('visible', true); // explizit sichtbar
    entry.setAttribute('clickable', true); // eigene Klasse

    const [angleYDeg, angleXDeg] = video.position.split(' ').map(Number);
    const radius = 3;
    const angleY = THREE.MathUtils.degToRad(angleYDeg);
    const angleX = THREE.MathUtils.degToRad(angleXDeg);

    const posX = radius * Math.sin(angleY) * Math.cos(angleX);
    const posY = radius * Math.sin(angleX);
    const posZ = -radius * Math.cos(angleY) * Math.cos(angleX);
    entry.setAttribute('position', `${posX} ${posY} ${posZ}`);
    entry.setAttribute('look-at', '[camera]');

    const icon = document.createElement('a-image');
    icon.setAttribute('src', 'media/videoicon.png');
    icon.setAttribute('width', '0.5');
    icon.setAttribute('height', '0.5');
    icon.setAttribute('material', 'color: white; opacity: 0.9');
    entry.appendChild(icon);

    const text = document.createElement('a-text');
    text.setAttribute('value', video.title);
    text.setAttribute('align', 'center');
    text.setAttribute('position', '0 -0.35 0');
    text.setAttribute('width', '2');
    text.setAttribute('color', 'white');
    entry.appendChild(text);

    menu.appendChild(entry);

    // Cursor-Animation
    entry.addEventListener('mouseenter', () => {
      progressRing.removeAttribute('animation__fill');
      progressRing.setAttribute('animation__fill',
        'property: theta-length; from: 0; to: 360; dur: 2000; easing: linear');
    });

    entry.addEventListener('mouseleave', () => {
      progressRing.removeAttribute('animation__fill');
      progressRing.setAttribute('theta-length', 0);
    });

    entry.addEventListener('click', () => {
      showRooms();
      const room = document.createElement('a-entity');
      room.classList.add('room');
      room.id = video.id;

      const sphere = document.createElement('a-videosphere');
      sphere.setAttribute('src', `#${video.id}`);
      room.appendChild(sphere);
      rooms.appendChild(room);

      videoEl.play();
    });
  });

  document.getElementById('loading').style.display = 'none';
});
</script>


    <!-- // <script>

    //    AFRAME.registerComponent('adjust-avatar', {
    //         tick: function () {
    //             const camera = document.querySelector('#camera');
    //             const anchor  = document.querySelector('#avatarAnchor');
    //             if (!camera || !anchor ) return;

    //             const camPos = camera.object3D.position;         
    //             anchor.setAttribute('position', `${camPos.x} ${camPos.y} ${camPos.z}`);

    //         }
    //     });

    //     // window.onload = async () => {
    //     document.querySelector('a-scene').addEventListener('loaded', async () => {
    //         // JSON laden
    //         const response = await fetch('videos.json');
    //         const data = await response.json();

    //         const menu = document.querySelector('#menu');
    //         const assets = document.querySelector('a-assets');

    //         // FÃ¼r jedes Video aus der JSON
    //         data.videos.forEach((video, i) => {
    //             // Video-Asset erzeugen
    //             const videoEl = document.createElement('video');
    //             videoEl.setAttribute('id', video.id);
    //             videoEl.setAttribute('src', video.src);
    //             videoEl.setAttribute('autoplay', '');
    //             videoEl.setAttribute('loop', '');
    //             videoEl.setAttribute('muted', '');
    //             videoEl.setAttribute('playsinline', '');
    //             videoEl.setAttribute('crossorigin', 'anonymous');
    //             assets.appendChild(videoEl);

    //             // MenÃ¼-Eintrag erzeugen
    //             const entry = document.createElement('a-entity');
    //             entry.classList.add('clickable');
    //             entry.setAttribute('id', `to-${video.id}`);

    //             // ---- Position auf der Kugel berechnen ----
    //             const [angleYDeg, angleXDeg] = video.position.split(' ').map(Number);
    //             const radius = 3; // Abstand von der Mitte (Kugelradius)
    //             const angleY = THREE.MathUtils.degToRad(angleYDeg); // horizontal
    //             const angleX = THREE.MathUtils.degToRad(angleXDeg); // vertikal

    //             // Kugelkoordinaten â†’ kartesisch
    //             const posX = radius * Math.sin(angleY) * Math.cos(angleX);
    //             // const posY = radius * Math.sin(angleX);
                
    //             const cameraY = document.querySelector('#camera').object3D.position.y;
    //             let rowOffset = 0;
    //             if (i < 3) rowOffset = 0.3;       // obere Reihe
    //             else rowOffset = -0.3;  
    //             const posY = cameraY + rowOffset; // oder cameraY + 0.1 fÃ¼r leicht Ã¼ber AugenhÃ¶he
    //             const posZ = -radius * Math.cos(angleY) * Math.cos(angleX);

    //             entry.setAttribute('position', `${posX} ${posY} ${posZ}`);
    //             entry.setAttribute('look-at', '[camera]'); // immer zur Kamera drehen

    //             // ---- Icon ----
    //             const icon = document.createElement('a-image');
    //             icon.setAttribute('src', 'media/videoicon.png');
    //             icon.setAttribute('width', '0.5');
    //             icon.setAttribute('height', '0.5');
    //             icon.setAttribute('position', '0 0 0');
    //             icon.setAttribute('material', 'color: white; opacity: 0.9');
    //             entry.appendChild(icon);

    //             // ---- Text ----
    //             const text = document.createElement('a-text');
    //             text.setAttribute('value', video.title);
    //             text.setAttribute('align', 'center');
    //             text.setAttribute('position', '0 -0.3 0');
    //             text.setAttribute('width', '2');
    //             text.setAttribute('color', 'white');
    //             entry.appendChild(text);

    //             // ---- MenÃ¼-Eintrag hinzufÃ¼gen ----
    //             menu.appendChild(entry);

    //             // ---- Cursor-Interaktion ----
    //             entry.addEventListener('mouseenter', () => {
    //                 progressRing.removeAttribute('animation__fill');
    //                 progressRing.setAttribute('animation__fill',
    //                 'property: theta-length; from: 0; to: 360; dur: 2000; easing: linear'
    //                 );
    //             });

    //             entry.addEventListener('mouseleave', () => {
    //                 progressRing.removeAttribute('animation__fill');
    //                 progressRing.setAttribute('theta-length', 0);
    //             });

    //             entry.addEventListener('click', () => {
    //                 menu.setAttribute('visible', 'false');
    //                 const room = document.createElement('a-entity');
    //                 room.setAttribute('id', video.id);
                   
    //                 const sphere = document.createElement('a-videosphere');
    //                 sphere.setAttribute('src', `#${video.id}`);
    //                 sphere.setAttribute('rotation', '0 0 0');

    //                 room.appendChild(sphere);
    //                 document.querySelector('a-scene').appendChild(room);

    //                 const videoEl = document.querySelector(`#${video.id}`);
    //                 videoEl.play();

    //             });
    //             });

    //         document.getElementById('loading').style.display = 'none';
    //     });
    //     </script> -->
    


</body>

</html>