<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mein VR-Prototyp</title>

    <!-- Load the A-Frame framework for building WebVR scenes -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
</head>

<body>
    <!-- Display a loading message before the scene is fully initialized -->
    <div id="loading">Loading scene...</div>


    <!-- Main VR scene container -->
    <a-scene adjust-avatar>
        <!-- Video assets -->
        <a-assets>
            <img id="menu_img" src="media/menu.png">
            <a-asset-item id="avatarModel" src="models/man_sitting.glb"></a-asset-item>
        </a-assets>

        <!-- Kamera: unabh√§ngig vom Avatar, wird vom Headset gesteuert -->
        <a-entity id="cameraRig" position="0 0 0">
            <a-entity id="camera" camera look-controls wasd-controls="enabled: false" raycaster="objects: .clickable">
                     
                <a-entity id="cursorBase" cursor="fuse: true; fuseTimeout: 2000" position="0 0 -0.5"
                        geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                        material="color: transparent; shader: flat">
            </a-entity>

            <a-ring id="progressRing" radius-inner="0.011" radius-outer="0.02" position="0 0 -0.5" color="#FFD700"
                    theta-start="0" theta-length="0">
            </a-ring>
            </a-entity>
        </a-entity>


           <!-- Menu 1 -->
        <a-entity id="menu" visible="true">
            <a-videosphere src="#menu_img" rotation="0 -102 0"></a-videosphere>
              <!-- Display a welcome message floating in front of the user -->
                <a-text value="Welcome!" align="center" position="0 1.5 -2" color="#ffffff" width="3"></a-text>
        </a-entity> 

        <a-entity id="rooms" visible="false">
            <!-- Avatar sichtbar nur hier -->
           <a-entity id="avatarAnchor">
                <a-entity id="avatarWrapper" hide-avatar-behind rotation="0 -45 0">
                    <a-entity id="avatar" gltf-model="#avatarModel"
                        position="-2 -1.3 0.27"
                        rotation="0 0 0"
                        scale="1 1 1">
                    </a-entity>
                </a-entity>
            </a-entity>

            <a-plane id="returnZone"
                position="0 3 0"
                rotation="90 0 0"
                width="4"
                height="4"
                material="color: #00ff00; opacity: 0; transparent: true"
                class="clickable"
                visible="false">
            </a-plane>


            <!-- R√§ume werden dynamisch erzeugt -->
        </a-entity>

   

        <!-- Enable hand tracking for left and right hands -->
        <a-entity id="leftHand" hand-tracking-controls="hand: left"></a-entity>
        <a-entity id="rightHand" hand-tracking-controls="hand: right"></a-entity>


    </a-scene>

<script>
    //Avatarpositionierung
    AFRAME.registerComponent('adjust-avatar', {
        tick: function () {
            const camera = document.querySelector('#camera');
            const anchor = document.querySelector('#avatarAnchor');
            const rooms = document.querySelector('#rooms');
            if (!camera || !anchor || !rooms) return;
            if (!rooms.getAttribute('visible')) return;

            const camPos = camera.object3D.position;
            anchor.object3D.position.copy(camPos);
        }
        });


       


    //Men√º anzeigen
    function showMenu() {
  const menu = document.querySelector('#menu');
  const rooms = document.querySelector('#rooms');
  const cursorBase = document.querySelector('#cursorBase');
  const progressRing = document.querySelector('#progressRing');
  const returnZone = document.querySelector('#returnZone');

  menu.setAttribute('visible', true);
  rooms.setAttribute('visible', false);
  cursorBase.object3D.visible = true;
  progressRing.object3D.visible = true;
  progressRing.setAttribute('theta-length', 0);
  returnZone.setAttribute('visible', false);

  // R√§ume bereinigen
  rooms.querySelectorAll('.room').forEach(r => r.remove());

  // Icons wieder aktivieren
  menu.querySelectorAll('[id^="to-"]').forEach(el => {
    el.setAttribute('visible', true);
    el.classList.add('clickable');
  });
}


//Raum anzeigen
function showRooms() {
  const menu = document.querySelector('#menu');
  const rooms = document.querySelector('#rooms');
  const cursorBase = document.querySelector('#cursorBase');
  const progressRing = document.querySelector('#progressRing');
  const returnZone = document.querySelector('#returnZone');

  menu.setAttribute('visible', false);
  rooms.setAttribute('visible', true);
  cursorBase.object3D.visible = false;
  progressRing.object3D.visible = false;
  returnZone.setAttribute('visible', true);
}

// const iconsPerRow = 3;
//     const rowSpacing = 0.9;
//     const colSpacing = 1.2;
//     const baseY = 1.2;

//     const row = Math.floor(index / iconsPerRow);
//     const col = index % iconsPerRow;

//     // Wie viele Icons sind in dieser Reihe?
//     const itemsInRow = Math.min(iconsPerRow, data.videos.length - row * iconsPerRow);

//     // Zentrierung: verschiebe die Reihe so, dass sie mittig liegt
//     const offsetX = (itemsInRow - 1) * colSpacing / 2;

//     // Versatz: jede zweite Reihe wird in die L√ºcken der oberen geschoben
//     const stagger = (row % 2 === 1)
//     ? colSpacing / 2
//     : 0;

//     const x = (col * colSpacing) - offsetX + stagger;
//     const y = baseY - (row * rowSpacing);
//     const z = -3;


//JSON laden und Icons erzeugen
document.querySelector('a-scene').addEventListener('loaded', async () => {
  const response = await fetch('videos.json');
  const data = await response.json();

  const menu = document.querySelector('#menu');
  const assets = document.querySelector('a-assets');
  const rooms = document.querySelector('#rooms');
  const progressRing = document.querySelector('#progressRing');

  data.videos.forEach((video, index) => {
    const videoEl = document.createElement('video');
    videoEl.id = video.id;
    videoEl.src = video.src;
    videoEl.autoplay = true;
    videoEl.loop = true;
    videoEl.muted = true;
    videoEl.playsInline = true;
    videoEl.crossOrigin = 'anonymous';
    assets.appendChild(videoEl);


    // Dynamische Positionierung der Icons auf der Kugel
    const total = data.videos.length;
    const maxRows = 4; // maximal 4 Reihen
    const radius = 3;  // Abstand vom Nutzer
    const verticalSpread = 1.0; // vertikaler Abstand zwischen Reihen (in Metern)
    const horizontalFOV = 80; // Bogenweite pro Reihe in Grad

    // Reihen bestimmen (z. B. bei 10 Videos ‚Üí 3, 3, 2, 2)
    const rows = Math.min(maxRows, total);
    const baseYAngle = -10; // Neigung der obersten Reihe
    const distribution = [];

    // Videos m√∂glichst gleichm√§√üig auf die Reihen verteilen
    let remaining = total;
    for (let i = 0; i < rows; i++) {
    const count = Math.ceil(remaining / (rows - i));
    distribution.push(count);
    remaining -= count;
    }

    // Positionen berechnen
    let videoIndex = 0;
    for (let row = 0; row < rows; row++) {
    const count = distribution[row];
    const pitch = baseYAngle - row * verticalSpread * 10; // H√∂he auf der Kugel (in Grad)
    const halfFOV = horizontalFOV / 2;

    for (let i = 0; i < count; i++) {
        const yaw = ((i / (count - 1)) - 0.5) * horizontalFOV; // horizontaler Winkel
        const yawRad = THREE.MathUtils.degToRad(yaw);
        const pitchRad = THREE.MathUtils.degToRad(pitch);

        // Kugelkoordinaten ‚Üí XYZ
        const x = radius * Math.sin(yawRad) * Math.cos(pitchRad);
        const y = radius * Math.sin(pitchRad);
        const z = -radius * Math.cos(yawRad) * Math.cos(pitchRad);

        const video = data.videos[videoIndex];
        videoIndex++;

        // Icon + Text erzeugen
        const entry = document.createElement('a-entity');
        entry.classList.add('clickable', 'menu-entry');
        entry.id = `to-${video.id}`;
        entry.setAttribute('position', `${x} ${y} ${z}`);
        entry.setAttribute('look-at', '[camera]');
        entry.setAttribute('visible', true);

        const icon = document.createElement('a-image');
        icon.setAttribute('src', 'media/videoicon.png');
        icon.setAttribute('width', '0.5');
        icon.setAttribute('height', '0.5');
        icon.setAttribute('material', 'color: white; opacity: 0.9');
        entry.appendChild(icon);

        const text = document.createElement('a-text');
        text.setAttribute('value', video.title);
        text.setAttribute('align', 'center');
        text.setAttribute('position', '0 -0.35 0');
        text.setAttribute('width', '2');
        text.setAttribute('color', 'white');
        entry.appendChild(text);

        menu.appendChild(entry);
    }
    }


    // const entry = document.createElement('a-entity');
    // entry.classList.add('clickable');
    // entry.id = `to-${video.id}`;
    // entry.setAttribute('position', `${x} ${y} ${z}`);
    // entry.setAttribute('look-at', '[camera]');
    // entry.setAttribute('visible', true);

    // const icon = document.createElement('a-image');
    // icon.setAttribute('src', 'media/videoicon.png');
    // icon.setAttribute('width', '0.5');
    // icon.setAttribute('height', '0.5');
    // icon.setAttribute('material', 'color: white; opacity: 0.9');
    // entry.appendChild(icon);

    // const text = document.createElement('a-text');
    // text.setAttribute('value', video.title);
    // text.setAttribute('align', 'center');
    // text.setAttribute('position', '0 -0.35 0');
    // text.setAttribute('width', '2');
    // text.setAttribute('color', 'white');
    // entry.appendChild(text);

    // menu.appendChild(entry);

    entry.addEventListener('mouseenter', () => {
      progressRing.removeAttribute('animation__fill');
      progressRing.setAttribute('animation__fill',
        'property: theta-length; from: 0; to: 360; dur: 2000; easing: linear');
    });

    entry.addEventListener('mouseleave', () => {
      progressRing.removeAttribute('animation__fill');
      progressRing.setAttribute('theta-length', 0);
    });

    entry.addEventListener('click', () => {
      showRooms();
      const room = document.createElement('a-entity');
      room.classList.add('room');
      room.id = video.id;

      const sphere = document.createElement('a-videosphere');
      sphere.setAttribute('src', `#${video.id}`);
      room.appendChild(sphere);
      rooms.appendChild(room);

      videoEl.play();
    });
  });

  document.getElementById('loading').style.display = 'none';

  const returnZone = document.querySelector('#returnZone');
const cursorBase = document.querySelector('#cursorBase');
//const progressRing = document.querySelector('#progressRing');

if (returnZone) {
  let returnTimer = null;

  returnZone.addEventListener('mouseenter', () => {
    cursorBase.object3D.visible = true;
    progressRing.object3D.visible = true;
    progressRing.removeAttribute('animation__fill');
    progressRing.setAttribute('animation__fill',
      'property: theta-length; from: 0; to: 360; dur: 5000; easing: linear');

    returnTimer = setTimeout(() => {
      showMenu();
      progressRing.removeAttribute('animation__fill');
      progressRing.setAttribute('theta-length', 0);
    }, 5000);
  });

  returnZone.addEventListener('mouseleave', () => {
    cursorBase.object3D.visible = false;
    progressRing.object3D.visible = false;
    progressRing.removeAttribute('animation__fill');
    progressRing.setAttribute('theta-length', 0);
    clearTimeout(returnTimer);
    returnTimer = null;
  });
}

});
</script>



   <!-- <script>
        AFRAME.registerComponent('adjust-avatar', {
        tick: function () {
            const camera = document.querySelector('#camera');
            const anchor = document.querySelector('#avatarAnchor');
            const rooms = document.querySelector('#rooms');
            if (!camera || !anchor || !rooms) return;
            if (!rooms.getAttribute('visible')) return;

            const camPos = camera.object3D.position;
            anchor.object3D.position.copy(camPos);
        }
        });

        AFRAME.registerComponent('room-return', {
        init: function () {
            this.lookTimer = 0;
            this.cursorShown = false;
        },
        tick: function (time, deltaTime) {
            const camera = document.querySelector('#camera');
            const rooms = document.querySelector('#rooms');
            const menu = document.querySelector('#menu');
            const cursorBase = document.querySelector('#cursorBase');
            const progressRing = document.querySelector('#progressRing');
            const entries = document.querySelectorAll('.clickable');

            if (!camera || !rooms || !menu || !cursorBase || !progressRing) return;

            const dir = new THREE.Vector3();
            camera.object3D.getWorldDirection(dir);
            const camPos = camera.object3D.getWorldPosition(new THREE.Vector3());

            const inRoom = rooms.getAttribute('visible');
            const inMenu = menu.getAttribute('visible');

            // üîπ Buttons nur aktiv im Men√º
            entries.forEach(el => {
            el.setAttribute('visible', inMenu);
            if (inMenu) {
                el.classList.add('clickable');
            } else {
                el.classList.remove('clickable');
            }
            });

            // üîπ Cursor im Men√º immer sichtbar
            if (inMenu) {
            cursorBase.object3D.visible = true;
            progressRing.object3D.visible = true;
            return;
            }

            // üîπ R√ºckblick aktivieren (Kopf nach oben)
            if (inRoom && dir.y > 0.7) {
            this.lookTimer += deltaTime;

            if (!this.cursorShown) {
                // Cursor & Ring sichtbar machen
                cursorBase.object3D.visible = true;
                progressRing.object3D.visible = true;

                // üîπ Position 0.5‚ÄØm in Blickrichtung
                const targetPos = camPos.clone().add(dir.clone().multiplyScalar(0.5));
                cursorBase.object3D.position.copy(targetPos);
                progressRing.object3D.position.copy(targetPos);

                // Ring f√ºllen starten
                progressRing.removeAttribute('animation__fill');
                progressRing.setAttribute('animation__fill',
                'property: theta-length; from: 0; to: 360; dur: 3000; easing: linear');

                this.cursorShown = true;
            }

            if (this.lookTimer > 5000) {
                showMenu();
                this.lookTimer = 0;
                this.cursorShown = false;
                progressRing.removeAttribute('animation__fill');
                progressRing.setAttribute('theta-length', 0);
            }
            } else {
            this.lookTimer = 0;
            if (this.cursorShown) {
                cursorBase.object3D.visible = false;
                progressRing.object3D.visible = false;
                progressRing.removeAttribute('animation__fill');
                progressRing.setAttribute('theta-length', 0);
                this.cursorShown = false;
            }
            }
        }
        });


        function showMenu() {
        const menu = document.querySelector('#menu');
        const rooms = document.querySelector('#rooms');
        const cursorBase = document.querySelector('#cursorBase');
        const progressRing = document.querySelector('#progressRing');
        const returnZone = document.querySelector('#returnZone');

        menu.setAttribute('visible', true);
        rooms.setAttribute('visible', false);
        cursorBase.object3D.visible = true;
        progressRing.object3D.visible = true;
        progressRing.setAttribute('theta-length', 0);

        // üîπ R√ºckkehrfl√§che deaktivieren
        returnZone.setAttribute('visible', false);

        // R√§ume bereinigen
        rooms.querySelectorAll('.room').forEach(r => r.remove());

        menu.querySelectorAll('.clickable').forEach(el => {
            el.setAttribute('visible', true);
            el.classList.add('clickable');
        });
        }


        function showRooms() {
        const menu = document.querySelector('#menu');
        const rooms = document.querySelector('#rooms');
        const cursorBase = document.querySelector('#cursorBase');
        const progressRing = document.querySelector('#progressRing');
        const returnZone = document.querySelector('#returnZone');

        menu.setAttribute('visible', false);
        rooms.setAttribute('visible', true);
        cursorBase.object3D.visible = false;
        progressRing.object3D.visible = false;

        // üîπ R√ºckkehrfl√§che aktivieren
        returnZone.setAttribute('visible', true);
        }


        /* ===== JSON-LADEN UND SZENE AUFBAUEN ===== */
        document.querySelector('a-scene').addEventListener('loaded', async () => {
            // R√ºckkehr-Zone aktivieren
            const returnZone = document.querySelector('#returnZone');
            if (returnZone) {
            returnZone.addEventListener('click', () => {
                showMenu();
            });
        }

        const response = await fetch('videos.json');
        const data = await response.json();

        const menu = document.querySelector('#menu');
        const assets = document.querySelector('a-assets');
        const rooms = document.querySelector('#rooms');
        const progressRing = document.querySelector('#progressRing');

        data.videos.forEach((video) => {
            // Video-Asset
            const videoEl = document.createElement('video');
            videoEl.id = video.id;
            videoEl.src = video.src;
            videoEl.autoplay = true;
            videoEl.loop = true;
            videoEl.muted = true;
            videoEl.playsInline = true;
            videoEl.crossOrigin = 'anonymous';
            assets.appendChild(videoEl);

            // Men√º-Icon + Text
            const entry = document.createElement('a-entity');
            entry.classList.add('clickable');
            entry.id = `to-${video.id}`;
            entry.setAttribute('visible', true); // explizit sichtbar
            entry.setAttribute('clickable', true); // eigene Klasse

            const [angleYDeg, angleXDeg] = video.position.split(' ').map(Number);
            const radius = 3;
            const angleY = THREE.MathUtils.degToRad(angleYDeg);
            const angleX = THREE.MathUtils.degToRad(angleXDeg);

            const posX = radius * Math.sin(angleY) * Math.cos(angleX);
            const posY = radius * Math.sin(angleX);
            const posZ = -radius * Math.cos(angleY) * Math.cos(angleX);
            entry.setAttribute('position', `${posX} ${posY} ${posZ}`);
            entry.setAttribute('look-at', '[camera]');

            const icon = document.createElement('a-image');
            icon.setAttribute('src', 'media/videoicon.png');
            icon.setAttribute('width', '0.5');
            icon.setAttribute('height', '0.5');
            icon.setAttribute('material', 'color: white; opacity: 0.9');
            entry.appendChild(icon);

            const text = document.createElement('a-text');
            text.setAttribute('value', video.title);
            text.setAttribute('align', 'center');
            text.setAttribute('position', '0 -0.35 0');
            text.setAttribute('width', '2');
            text.setAttribute('color', 'white');
            entry.appendChild(text);

            menu.appendChild(entry);

            // Cursor-Animation
            entry.addEventListener('mouseenter', () => {
            progressRing.removeAttribute('animation__fill');
            progressRing.setAttribute('animation__fill',
                'property: theta-length; from: 0; to: 360; dur: 2000; easing: linear');
            });

            entry.addEventListener('mouseleave', () => {
            progressRing.removeAttribute('animation__fill');
            progressRing.setAttribute('theta-length', 0);
            });

            if (returnZone) {
                returnZone.addEventListener('mouseenter', () => {
                    cursorBase.object3D.visible = true;
                    progressRing.object3D.visible = true;
                    progressRing.removeAttribute('animation__fill');
                    progressRing.setAttribute('animation__fill',
                    'property: theta-length; from: 0; to: 360; dur: 5000; easing: linear');
                });

                returnZone.addEventListener('mouseleave', () => {
                    cursorBase.object3D.visible = false;
                    progressRing.object3D.visible = false;
                    progressRing.removeAttribute('animation__fill');
                    progressRing.setAttribute('theta-length', 0);
                });
                }

            entry.addEventListener('click', () => {
            showRooms();
            const room = document.createElement('a-entity');
            room.classList.add('room');
            room.id = video.id;

            const sphere = document.createElement('a-videosphere');
            sphere.setAttribute('src', `#${video.id}`);
            room.appendChild(sphere);
            rooms.appendChild(room);

            videoEl.play();
            });
        });

        

        document.getElementById('loading').style.display = 'none';
        });
        </script> -->
    </body>
</html>