<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mein VR-Prototyp</title>

    <!-- Load the A-Frame framework for building WebVR scenes -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
</head>

<body>
    <!-- Display a loading message before the scene is fully initialized -->
    <div id="loading">Loading scene...</div>


    <!-- Main VR scene container -->
    <a-scene adjust-avatar>
        <!-- Video assets -->
        <a-assets>
            <img id="menu_img" src="media/menu.png">
            <a-asset-item id="avatarModel" src="models/man_sitting.glb"></a-asset-item>
        </a-assets>

        <!-- Kamera: unabhängig vom Avatar, wird vom Headset gesteuert -->
        <a-entity id="cameraRig" position="0 0 0">
            <a-entity id="camera" camera look-controls wasd-controls="enabled: false" raycaster="objects: .clickable">
                     
                <a-entity id="cursorBase" cursor="fuse: true; fuseTimeout: 2000" position="0 0 -0.5"
                        geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                        material="color: transparent; shader: flat">
            </a-entity>

            <a-ring id="progressRing" radius-inner="0.011" radius-outer="0.02" position="0 0 -0.5" color="#FFD700"
                    theta-start="0" theta-length="0">
            </a-ring>
            </a-entity>
        </a-entity>


           <!-- Menu 1 -->
        <a-entity id="menu" position="0 0 0" 0visible="true">
            <a-videosphere src="#menu_img" rotation="0 -102 0"></a-videosphere>
              <!-- Display a welcome message floating in front of the user -->
                <a-text value="Welcome" align="center" position="0 1.8 -2" color="#ffffff" width="3"></a-text>
        </a-entity> 

        <a-entity id="rooms" visible="false">
            <!-- Avatar sichtbar nur hier -->
           <a-entity id="avatarAnchor">
                <a-entity id="avatarWrapper" hide-avatar-behind rotation="0 -45 0">
                    <a-entity id="avatar" gltf-model="#avatarModel"
                        position="-2 -1.3 0.27"
                        rotation="0 0 0"
                        scale="1 1 1">
                    </a-entity>
                </a-entity>
            </a-entity>

            <a-plane id="returnZone"
                position="0 3 0"
                rotation="90 0 0"
                width="2"
                height="2"
                material="color: #00ff00; opacity: 0; transparent: true"
                class="clickable"
                visible="false">
            </a-plane>

            <!-- Räume werden dynamisch erzeugt -->
        </a-entity>


        <!-- Enable hand tracking for left and right hands -->
        <a-entity id="leftHand" hand-tracking-controls="hand: left"></a-entity>
        <a-entity id="rightHand" hand-tracking-controls="hand: right"></a-entity>
    </a-scene>





    <script>


// URL-Parameter auslesen
const urlParams = new URLSearchParams(window.location.search);
const testCount = parseInt(urlParams.get('count')) || 5; // default 5

// Testdaten erzeugen
const data = { videos: [] };
for (let i = 1; i <= testCount; i++) {
    data.videos.push({
        id: `${i}`,
        title: `Test Video ${i}`,
        src: `media/room${i}.mp4`
    });
}

// Menü initialisieren mit Testdaten
initMenu(data);



// ---------------------------
// VR Menü + Video Dynamik Script
// ---------------------------



AFRAME.registerComponent('adjust-avatar', {
    tick: function () {
        const camera = document.querySelector('#camera');
        const anchor = document.querySelector('#avatarAnchor');
        const rooms = document.querySelector('#rooms');
        if (!camera || !anchor || !rooms) return;
        if (!rooms.getAttribute('visible')) return;
        anchor.object3D.position.copy(camera.object3D.position);
    }
});

// Global references
const scene = document.querySelector('a-scene');
const menu = document.querySelector('#menu');
const rooms = document.querySelector('#rooms');
const cursorBase = document.querySelector('#cursorBase');
const progressRing = document.querySelector('#progressRing');
const returnZone = document.querySelector('#returnZone');
const camera = document.querySelector('#camera');

if (camera && menu) {
  const camPos = camera.object3D.position;
  menu.setAttribute('position', `${camPos.x} ${camPos.y + 1.3} ${camPos.z - 2}`);
}

// ---------------------------
// Menü & Räume
// ---------------------------
async function initMenu() {
    const response = await fetch('videos.json');
    const data = await response.json();
    const assets = document.querySelector('a-assets');

    // Video Assets erstellen
    data.videos.forEach(video => {
        const videoEl = document.createElement('video');
        videoEl.id = `video-${video.id}`;
        videoEl.src = video.src;
        videoEl.autoplay = true;
        videoEl.loop = true;
        videoEl.muted = true;
        videoEl.playsInline = true;
        videoEl.setAttribute('playsinline', 'true');
        videoEl.setAttribute('webkit-playsinline', 'true');
        videoEl.crossOrigin = 'anonymous';
        assets.appendChild(videoEl);
    });

    // Berechne Layout
const total = data.videos.length;
const maxRows = 4;
const rowHeight = 0.8;
const baseY = 1.5; // Starthöhe
const rows = Math.min(maxRows, Math.ceil(total / 3));

// Verteile Videos auf Reihen
let itemsPerRow = [];
let remaining = total;
for (let r = 0; r < rows; r++) {
    let count = Math.ceil(remaining / (rows - r));
    itemsPerRow.push(count);
    remaining -= count;
}

// Berechne maximale Anzahl in den Reihen (maxRowWidth)
const maxCount = Math.max(...itemsPerRow);

let videoIndex = 0;
const rowPositions = []; // speichert die x-Positionen jeder Reihe

for (let r = 0; r < rows; r++) {
    const count = itemsPerRow[r];
    const y = baseY - r * rowHeight;
    const spacing = 1.2;

    let xPositions = [];

    if (r === 0) {
        // Erste Reihe: normale Verteilung
        const rowWidth = (count - 1) * spacing;
        const offsetX = -rowWidth / 2;
        for (let i = 0; i < count; i++) {
            xPositions.push(offsetX + i * spacing);
        }
    } else {
        // Untere Reihen: Positionierung unter Lücken der oberen Reihe
        const prevRow = rowPositions[r - 1];
        const prevCount = prevRow.length;
        for (let i = 0; i < count; i++) {
            const t = (i + 0.5) / count; // Mittig in den Lücken
            const index = Math.floor(t * (prevCount - 1));
            const nextIndex = Math.min(index + 1, prevCount - 1);
            const x = (prevRow[index] + prevRow[nextIndex]) / 2;
            xPositions.push(x);
        }
    }

    // Speichere die Positionen für die nächste Reihe
    rowPositions.push(xPositions);

    // Icons erstellen
    for (let i = 0; i < count; i++) {
        const video = data.videos[videoIndex++];
        const x = xPositions[i];
        const z = -3;

        const entry = document.createElement('a-entity');
        entry.classList.add('clickable', 'menu-entry');
        entry.id = `to-${video.id}`;
        entry.setAttribute('position', `${x} ${y} ${z}`);
        entry.setAttribute('look-at', '[camera]');

        // Icon
        const icon = document.createElement('a-image');
        icon.setAttribute('src', 'media/videoicon.png');
        icon.setAttribute('width', '0.45');
        icon.setAttribute('height', '0.45');
        icon.setAttribute('material', 'color: white; opacity: 0.9');
        entry.appendChild(icon);

        // Text
        const text = document.createElement('a-text');
        text.setAttribute('value', video.title);
        text.setAttribute('align', 'center');
        text.setAttribute('position', '0 -0.35 0');
        text.setAttribute('width', '2');
        text.setAttribute('color', 'white');
        entry.appendChild(text);

        menu.appendChild(entry);

        // Fuse / Hover Logik
        let fuseTimeout = null;
        entry.addEventListener('mouseenter', () => {
            icon.setAttribute('material', 'color: yellow');
            progressRing.setAttribute('theta-length', 0);
            progressRing.setAttribute('animation__fill', 'property: theta-length; from:0; to:360; dur:3000; easing: linear');
            fuseTimeout = setTimeout(() => openRoom(video.id), 3000);
        });
        entry.addEventListener('mouseleave', () => {
            icon.setAttribute('material', 'color: white');
            progressRing.removeAttribute('animation__fill');
            progressRing.setAttribute('theta-length', 0);
            clearTimeout(fuseTimeout);
        });
    }
}
}



    // // Icons + Text erzeugen
    // const radius = 3;
    // const horizontalSpread = 60;
    // const verticalSpread = 0.8;
    // let total = data.videos.length;
    // let angles = [];
    // for (let i = 0; i < total; i++) angles.push(-horizontalSpread/2 + i*(horizontalSpread/(total-1)));

    // for (let i = 0; i < total; i++) {
    //     const video = data.videos[i];
    //     const yawRad = THREE.MathUtils.degToRad(angles[i]);
    //     const x = radius * Math.sin(yawRad);
    //     const z = -radius * Math.cos(yawRad);
    //     const y = 1.5 - Math.floor(i/3)*verticalSpread;

    //     const entry = document.createElement('a-entity');
    //     entry.classList.add('clickable', 'menu-entry');
    //     entry.id = `to-${video.id}`;
    //     entry.setAttribute('position', `${x} ${y} ${z}`);
    //     entry.setAttribute('look-at', '[camera]');

    //     // Icon
    //     const icon = document.createElement('a-image');
    //     icon.setAttribute('src', 'media/videoicon.png');
    //     icon.setAttribute('width', '0.45');
    //     icon.setAttribute('height', '0.45');
    //     icon.setAttribute('material', 'color: white; opacity: 0.9');
    //     entry.appendChild(icon);

    //     // Text
    //     const text = document.createElement('a-text');
    //     text.setAttribute('value', video.title);
    //     text.setAttribute('align', 'center');
    //     text.setAttribute('position', '0 -0.35 0');
    //     text.setAttribute('width', '2');
    //     text.setAttribute('color', 'white');
    //     entry.appendChild(text);

    //     menu.appendChild(entry);

    //     // Interaktionen
    //     let fuseTimeout = null;

    //     entry.addEventListener('mouseenter', () => {
    //         icon.setAttribute('material', 'color: yellow');
    //         progressRing.setAttribute('theta-length', 0);
    //         progressRing.setAttribute('animation__fill', 'property: theta-length; from:0; to:360; dur:3000; easing: linear');
    //         fuseTimeout = setTimeout(() => openRoom(video.id), 3000);
    //     });

    //     entry.addEventListener('mouseleave', () => {
    //         icon.setAttribute('material', 'color: white');
    //         progressRing.removeAttribute('animation__fill');
    //         progressRing.setAttribute('theta-length', 0);
    //         clearTimeout(fuseTimeout);
    //     });
    // }


function showMenuState() {
    menu.setAttribute('visible', true);
    rooms.querySelectorAll('.room').forEach(r => r.remove());
    rooms.setAttribute('visible', false);

    document.querySelector('#avatarAnchor').setAttribute('visible', false);

    // Cursor + Ring **immer vor Kamera sichtbar** im Menü
    cursorBase.object3D.visible = true;
    progressRing.object3D.visible = true;

    progressRing.removeAttribute('animation__fill');
    progressRing.setAttribute('theta-length', 0);
}

function openRoom(videoId) {
    menu.setAttribute('visible', false);
    rooms.setAttribute('visible', true);
    document.querySelector('#avatarAnchor').setAttribute('visible', true);

    // Cursor und Ring standardmäßig im Raum unsichtbar
    cursorBase.object3D.visible = false;
    progressRing.object3D.visible = false;

    // Videosphere erzeugen
    let room = document.querySelector(`#room-${videoId}`);
    if (!room) {
        room = document.createElement('a-entity');
        room.id = `room-${videoId}`;
        room.classList.add('room');
        const sphere = document.createElement('a-videosphere');
        sphere.setAttribute('src', `#video-${videoId}`);
        room.appendChild(sphere);
        rooms.appendChild(room);
    } else {
        room.setAttribute('visible', 'true');
    }

    const videoEl = document.querySelector(`#video-${videoId}`);
    if (videoEl) videoEl.play().catch(err => console.warn('Video konnte nicht starten:', err));
}

// Return-Zone Fuse
let returnTimer = null;
returnZone.addEventListener('mouseenter', () => {
    // Cursor & Ring nur temporär sichtbar während Fuse
    cursorBase.object3D.visible = true;
    progressRing.object3D.visible = true;
    progressRing.setAttribute('animation__fill', 'property: theta-length; from:0; to:360; dur:5000; easing: linear');

    returnTimer = setTimeout(() => {
        showMenuState(); // Menü zurück → Cursor dauerhaft sichtbar
    }, 5000);
});

returnZone.addEventListener('mouseleave', () => {
    // Nach Fuse abbrechen: Cursor + Ring wieder unsichtbar im Raum
    progressRing.removeAttribute('animation__fill');
    progressRing.setAttribute('theta-length', 0);
    if (!menu.getAttribute('visible')) {
        cursorBase.object3D.visible = false;
        progressRing.object3D.visible = false;
    }
    clearTimeout(returnTimer);
});




// let returnTimer = null;
// returnZone.addEventListener('mouseenter', () => {
//     cursorBase.object3D.visible = true;
//     progressRing.object3D.visible = true;
//     progressRing.setAttribute('animation__fill', 'property: theta-length; from:0; to:360; dur:5000; easing: linear');

//     returnTimer = setTimeout(() => {
//         // Menü wieder sichtbar
//         menu.setAttribute('visible', true);

//         // Räume löschen und ausblenden
//         rooms.querySelectorAll('.room').forEach(r => r.remove());
//         rooms.setAttribute('visible', false);

//         // Avatar ausblenden
//         document.querySelector('#avatarAnchor').setAttribute('visible', false);

//         // Cursor + Progress-Ring wieder sichtbar im Menü
//         cursorBase.object3D.visible = true;
//         progressRing.object3D.visible = true;

//         // Animation stoppen
//         progressRing.removeAttribute('animation__fill');
//         progressRing.setAttribute('theta-length', 0);
//     }, 5000);
// });

// returnZone.addEventListener('mouseleave', () => {
//     cursorBase.object3D.visible = false;
//     progressRing.object3D.visible = false;
//     progressRing.removeAttribute('animation__fill');
//     progressRing.setAttribute('theta-length', 0);
//     clearTimeout(returnTimer);
// });


// ---------------------------
// Szene geladen → Menü initialisieren
// ---------------------------
scene.addEventListener('loaded', () => {
    initMenu();
    document.getElementById('loading').style.display = 'none';
});
</script>


    </body>
</html>