<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mein VR-Prototyp</title>

    <!-- Load the A-Frame framework for building WebVR scenes -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
</head>

<body>
    <!-- Display a loading message before the scene is fully initialized -->
    <div id="loading">Loading scene...</div>


    <!-- Main VR scene container -->
    <a-scene adjust-avatar>
        <!-- Video assets -->
        <a-assets>
            <img id="menu_img" src="media/menu.png">
            <a-asset-item id="avatarModel" src="models/man_sitting.glb"></a-asset-item>
        </a-assets>

        <!-- Kamera: unabhängig vom Avatar, wird vom Headset gesteuert -->
        <a-entity id="cameraRig" position="0 0 0">
            <a-entity id="camera" camera look-controls wasd-controls="enabled: false" raycaster="objects: .clickable">
                     
                <a-entity id="cursorBase" cursor="fuse: true; fuseTimeout: 2000" position="0 0 -0.5"
                        geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                        material="color: transparent; shader: flat">
            </a-entity>

            <a-ring id="progressRing" radius-inner="0.011" radius-outer="0.02" position="0 0 -0.5" color="#FFD700"
                    theta-start="0" theta-length="0">
            </a-ring>
            </a-entity>
        </a-entity>


           <!-- Menu 1 -->
        <a-entity id="menu" visible="true">
            <a-videosphere src="#menu_img" rotation="0 -102 0"></a-videosphere>
            <!-- Display a welcome message floating in front of the user -->
            <!-- <a-text value="Welcome" align="center" position="0 1.8 -2" color="#ffffff" width="3"></a-text> -->
             <a-text id="welcomeText" value="Welcome!" align="center" color="#ffffff" width="3"></a-text>
        </a-entity> 

        <a-entity id="rooms" visible="false">
            <!-- Avatar sichtbar nur hier -->
           <a-entity id="avatarAnchor">
                <a-entity id="avatarWrapper" hide-avatar-behind rotation="0 -45 0">
                    <a-entity id="avatar" gltf-model="#avatarModel"
                        position="-2 -1.3 0.27"
                        rotation="0 0 0"
                        scale="1 1 1">
                    </a-entity>
                </a-entity>
            </a-entity>

            <a-plane id="returnZone"
                position="0 3 0"
                rotation="90 0 0"
                width="2"
                height="2"
                material="color: #00ff00; opacity: 0; transparent: true"
                class="clickable"
                visible="false">
            </a-plane>

            <!-- Räume werden dynamisch erzeugt -->
        </a-entity>


        <!-- Enable hand tracking for left and right hands -->
        <a-entity id="leftHand" hand-tracking-controls="hand: left"></a-entity>
        <a-entity id="rightHand" hand-tracking-controls="hand: right"></a-entity>
    </a-scene>





    <script>

   // --- TESTDATEN FÜR ICON-PLATZIERUNG ---
const testVideosSets = [
    // Set 1: 2 Videos
    [
        { id: 'v1', title: 'Video 1' },
        { id: 'v2', title: 'Video 2' },
        { id: 'v2', title: 'Video 3' },
        { id: 'v2', title: 'Video 4' },
        { id: 'v2', title: 'Video 5' },
        { id: 'v2', title: 'Video 6' },
        { id: 'v2', title: 'Video 7' },
        { id: 'v2', title: 'Video 8' },
        { id: 'v2', title: 'Video 9' }
    ]
];


// ---------------------------
// VR Menü + Video Dynamik Script
// ---------------------------


// Global references
const scene = document.querySelector('a-scene');
const menu = document.querySelector('#menu');
const rooms = document.querySelector('#rooms');
const cursorBase = document.querySelector('#cursorBase');
const progressRing = document.querySelector('#progressRing');
const returnZone = document.querySelector('#returnZone');
const camera = document.querySelector('#camera');

 let menuMusicEntity = null;

// -------
// Avatar
// -------

AFRAME.registerComponent('adjust-avatar', {
  init: function () {
    this.lastYRot = 0;
    this.frameCount = 0;
    this.isVR = false;

    // Prüfe VR-Modus nach Szenenstart
    this.el.sceneEl.addEventListener('enter-vr', () => {
      this.isVR = true;
    });
    this.el.sceneEl.addEventListener('exit-vr', () => {
      this.isVR = false;
    });
  },

  tick: function () {
    const camera = document.querySelector('#camera');
    const anchor = document.querySelector('#avatarAnchor');
    const rooms = document.querySelector('#rooms');
    if (!camera || !anchor || !rooms) return;
    if (!rooms.getAttribute('visible')) return;

    const cam = camera.object3D;
    const anchorObj = anchor.object3D;
    if (!cam || !anchorObj) return;

    // --- Position setzen ---
    anchorObj.position.set(cam.position.x, cam.position.y, cam.position.z);

    // --- Blickrichtung berechnen ---
    const dir = new THREE.Vector3();
    cam.getWorldDirection(dir);
    const targetYRot = Math.atan2(dir.x, dir.z);

    // --- Verhalten je nach Gerät ---
    if (this.isVR) {
      // Sanftes Nachziehen in VR
      this.frameCount++;
      const updateInterval = 10;
      if (this.frameCount % updateInterval === 0) {
        const delta = targetYRot - this.lastYRot;
        const wrappedDelta = Math.atan2(Math.sin(delta), Math.cos(delta));
        const threshold = 0.1;
        if (Math.abs(wrappedDelta) > threshold) {
          this.lastYRot += wrappedDelta * 0.3;
          anchorObj.rotation.set(0, this.lastYRot, 0);
        }
      }
    } else {
      // Direktes Folgen auf PC
      const smoothing = 0.3;
      const delta = targetYRot - anchorObj.rotation.y;
      const wrappedDelta = Math.atan2(Math.sin(delta), Math.cos(delta));
      anchorObj.rotation.y += wrappedDelta * smoothing;
    }
  }
});


// ---------------------------
// Menü & Räume
// ---------------------------

//async function initMenu() {
async function initMenu(testVideos = null) {
    // const response = await fetch('videos.json');
    // const data = await response.json();

    let data;
    if (testVideos) {
        data = { videos: testVideos, menuMusic: null };
    } else {
        const response = await fetch('videos.json');
        data = await response.json();
    }

    const assets = document.querySelector('a-assets');



    // Video Assets erstellen
    data.videos.forEach(video => {
        const videoEl = document.createElement('video');
        videoEl.id = `video-${video.id}`;
        videoEl.src = video.src;
        videoEl.autoplay = true;
        videoEl.loop = true;
        videoEl.muted = true;
        videoEl.playsInline = true;
        videoEl.setAttribute('playsinline', 'true');
        videoEl.setAttribute('webkit-playsinline', 'true');
        videoEl.crossOrigin = 'anonymous';
        assets.appendChild(videoEl);

        // Musik-Asset (falls vorhanden)
        if (video.music) {
            const audioEl = document.createElement('audio');
            audioEl.id = `music-${video.id}`;
            audioEl.src = video.music;
            audioEl.setAttribute('preload', 'auto');
            audioEl.setAttribute('crossorigin', 'anonymous');
            assets.appendChild(audioEl);
        }

    });

    // Menü-Musik laden (falls vorhanden)
    if (data.menuMusic) {
    const menuAudio = document.createElement('audio');
    menuAudio.id = 'menuMusic';
    menuAudio.src = data.menuMusic;
    menuAudio.setAttribute('preload', 'auto');
    menuAudio.setAttribute('crossorigin', 'anonymous');
    assets.appendChild(menuAudio);

    // const soundEntity = document.createElement('a-entity');
    // soundEntity.id = 'menuMusicEntity';
    // soundEntity.setAttribute('sound', 'src: #menuMusic; loop: true; volume: 0.5'); // autoplay entfernt
    // menu.appendChild(soundEntity);

    // Menü-Musik-Entity sofort für erstes Abspielen vorbereiten
const menuMusicEntity = document.querySelector('#menuMusicEntity');
if (menuMusicEntity && menuMusicEntity.components.sound) {
    // Verzögerung, damit die Sound-Komponente vollständig geladen ist
    setTimeout(() => {
        menuMusicEntity.components.sound.playSound(); // hörbar starten
    }, 100); 
}


    }

    // Kamera-Höhe für Menü-Position ermitteln
    const camY = camera.object3D.position.y || 1.3; // Fallback für PC
    const iconsBaseY = camY; // Zentrum der Icons auf Augenhöhe
    const welcomeTextY = iconsBaseY + 0.6; // Welcome Text leicht darüber

    // Welcome Text
    let welcome = document.querySelector('#welcomeText');
    if (!welcome) {
        welcome = document.createElement('a-text');
        welcome.id = 'welcomeText';
        welcome.setAttribute('value', 'Welcome');
        welcome.setAttribute('align', 'center');
        welcome.setAttribute('color', 'white');
        welcome.setAttribute('width', '3');
        menu.appendChild(welcome);
    }
    welcome.setAttribute('position', `0 ${welcomeTextY} -3`);

//     // Layout für Icons berechnen
//     const total = data.videos.length;
//     const maxRows = 4;
//     const rowHeight = 0.8;

//     const rows = Math.min(maxRows, Math.ceil(total / 3));
//     let itemsPerRow = [];
//     let remaining = total;
//     for (let r = 0; r < rows; r++) {
//         let count = Math.ceil(remaining / (rows - r));
//         itemsPerRow.push(count);
//         remaining -= count;
//     }

//     const rowPositions = [];
//     let videoIndex = 0;

//     for (let r = 0; r < rows; r++) {
//         const count = itemsPerRow[r];
//         const y = iconsBaseY - r * rowHeight;
//         const spacing = 1.2;

//         let xPositions = [];
//         if (r === 0) {
//             const rowWidth = (count - 1) * spacing;
//             const offsetX = -rowWidth / 2;
//             for (let i = 0; i < count; i++) {
//                 xPositions.push(offsetX + i * spacing);
//             }
//         // } else {
//         //     // Untere Reihen: Positionierung unter Lücken der oberen Reihe
//         //     const prevRow = rowPositions[r - 1];
//         //     const prevCount = prevRow.length;
//         //     for (let i = 0; i < count; i++) {
//         //         const t = (i + 0.5) / count; // mittig zwischen vorherigen Icons
//         //         const index = Math.floor(t * (prevCount - 1));
//         //         const nextIndex = Math.min(index + 1, prevCount - 1);
//         //         const x = (prevRow[index] + prevRow[nextIndex]) / 2;
//         //         xPositions.push(x);
//         //     }
//         // }
//         } else {
//     const rowWidth = (count - 1) * spacing;
//     const offsetX = -rowWidth / 2;
//     for (let i = 0; i < count; i++) {
//         xPositions.push(offsetX + i * spacing);
//     }
// }


//         rowPositions.push(xPositions);

//         // Icons + Texte erzeugen
//         for (let i = 0; i < count; i++) {
//             const video = data.videos[videoIndex++];
//             const x = xPositions[i];
//             const z = -3;

//             const entry = document.createElement('a-entity');
//             entry.classList.add('clickable', 'menu-entry');
//             entry.id = `to-${video.id}`;
//             entry.setAttribute('position', `${x} ${y} ${z}`);
//             entry.setAttribute('look-at', '[camera]');

//             // Icon
//             const icon = document.createElement('a-image');
//             icon.setAttribute('src', 'media/videoicon.png');
//             icon.setAttribute('width', '0.45');
//             icon.setAttribute('height', '0.45');
//             icon.setAttribute('material', 'color: white; opacity: 0.9');
//             entry.appendChild(icon);

//             // Text
//             const text = document.createElement('a-text');
//             text.setAttribute('value', video.title);
//             text.setAttribute('align', 'center');
//             text.setAttribute('position', '0 -0.35 0');
//             text.setAttribute('width', '2');
//             text.setAttribute('color', 'white');
//             entry.appendChild(text);

//             menu.appendChild(entry);

//             // Fuse / Hover Logik
//             let fuseTimeout = null;
//             entry.addEventListener('mouseenter', () => {
//                 icon.setAttribute('material', 'color: yellow');
//                 progressRing.setAttribute('theta-length', 0);
//                 progressRing.setAttribute('animation__fill', 'property: theta-length; from:0; to:360; dur:3000; easing: linear');
//                 fuseTimeout = setTimeout(() => openRoom(video.id), 3000);
//             });
//             entry.addEventListener('mouseleave', () => {
//                 icon.setAttribute('material', 'color: white');
//                 progressRing.removeAttribute('animation__fill');
//                 progressRing.setAttribute('theta-length', 0);
//                 clearTimeout(fuseTimeout);
//             });
//         }
//     }

// Layout für Icons berechnen
const total = data.videos.length;
const rowHeight = 0.8;


// Funktion, die die Anzahl der Icons pro Reihe zurückgibt
function getItemsPerRow(total) {
    switch (total) {
        case 1: return [1];
        case 2: return [2];
        case 3: return [3];
        case 4: return [2,2];
        case 5: return [3,2];
        case 6: return [3,3];
        case 7: return [4,3];
        case 8: return [4,4];
        case 9: return [3,3,3];
        case 10: return [4,3,3];
        case 11: return [4,3,4];
        case 12: return [4,4,4];
        default:
            // Für mehr als 12, max 4 pro Reihe
            const rows = Math.ceil(total / 4);
            let result = [];
            let remaining = total;
            for (let i = 0; i < rows; i++) {
                result.push(Math.min(4, remaining));
                remaining -= 4;
            }
            return result;
    }
}

const itemsPerRow = getItemsPerRow(total);
const rowPositions = [];
let videoIndex = 0;

for (let r = 0; r < itemsPerRow.length; r++) {
    const count = itemsPerRow[r];
    const y = iconsBaseY - r * rowHeight;
    const spacing = 1.2;
    const rowWidth = (count - 1) * spacing;
    const offsetX = -rowWidth / 2;

    let xPositions = [];
    for (let i = 0; i < count; i++) {
        xPositions.push(offsetX + i * spacing);
    }
    rowPositions.push(xPositions);

    // Icons + Texte erzeugen
    for (let i = 0; i < count; i++) {
        const video = data.videos[videoIndex++];
        const x = xPositions[i];
        const z = -3;

        const entry = document.createElement('a-entity');
        entry.classList.add('clickable', 'menu-entry');
        entry.id = `to-${video.id}`;
        entry.setAttribute('position', `${x} ${y} ${z}`);
        entry.setAttribute('look-at', '[camera]');

        // Icon
        const icon = document.createElement('a-image');
        icon.setAttribute('src', 'media/videoicon.png');
        icon.setAttribute('width', '0.45');
        icon.setAttribute('height', '0.45');
        icon.setAttribute('material', 'color: white; opacity: 0.9');
        entry.appendChild(icon);

        // Text
        const text = document.createElement('a-text');
        text.setAttribute('value', video.title);
        text.setAttribute('align', 'center');
        text.setAttribute('position', '0 -0.35 0');
        text.setAttribute('width', '2');
        text.setAttribute('color', 'white');
        entry.appendChild(text);

        menu.appendChild(entry);

        // Fuse / Hover Logik
        let fuseTimeout = null;
        entry.addEventListener('mouseenter', () => {
            icon.setAttribute('material', 'color: yellow');
            progressRing.setAttribute('theta-length', 0);
            progressRing.setAttribute('animation__fill', 'property: theta-length; from:0; to:360; dur:3000; easing: linear');
            fuseTimeout = setTimeout(() => openRoom(video.id), 3000);
        });
        entry.addEventListener('mouseleave', () => {
            icon.setAttribute('material', 'color: white');
            progressRing.removeAttribute('animation__fill');
            progressRing.setAttribute('theta-length', 0);
            clearTimeout(fuseTimeout);
        });
    }
}


// Menü-Musik laden (falls vorhanden)
if (data.menuMusic) {
    const menuAudio = document.createElement('audio');
    menuAudio.id = 'menuMusic';
    menuAudio.src = data.menuMusic;
    menuAudio.setAttribute('preload', 'auto');
    menuAudio.setAttribute('crossorigin', 'anonymous');
    assets.appendChild(menuAudio);

    // Musik-Entity erstellen
    menuMusicEntity = document.createElement('a-entity');
    menuMusicEntity.id = 'menuMusicEntity';
    menuMusicEntity.setAttribute('sound', 'src: #menuMusic; loop: true; volume: 0.5');
    menu.appendChild(menuMusicEntity);

    // AudioContext aktivieren, sobald Sound-Komponente geladen ist
    menuMusicEntity.addEventListener('sound-loaded', () => {
        menuMusicEntity.components.sound.playSound();
        menuMusicEntity.components.sound.stopSound();
    });

    // User-Interaktion zum ersten hörbaren Start
    const startMenuMusic = () => {
        if (menuMusicEntity && menuMusicEntity.components.sound) {
            menuMusicEntity.components.sound.playSound();
        }
        window.removeEventListener('click', startMenuMusic);
        window.removeEventListener('touchstart', startMenuMusic);
        window.removeEventListener('mousemove', startMenuMusic);
    };
    window.addEventListener('click', startMenuMusic);
    window.addEventListener('touchstart', startMenuMusic);
    window.addEventListener('mousemove', startMenuMusic);
}

}

function showMenuState() {
    menu.setAttribute('visible', true);
    rooms.querySelectorAll('.room').forEach(r => r.remove());
    rooms.setAttribute('visible', false);

    document.querySelector('#avatarAnchor').setAttribute('visible', false);

    cursorBase.object3D.visible = true;
    progressRing.object3D.visible = true;
    progressRing.removeAttribute('animation__fill');
    progressRing.setAttribute('theta-length', 0);

    // Menü-Musik wieder starten
    if (menuMusicEntity && menuMusicEntity.components.sound) {
        menuMusicEntity.components.sound.playSound();
    }
}




function openRoom(videoId) {
    menu.setAttribute('visible', false);
    rooms.setAttribute('visible', true);
    document.querySelector('#avatarAnchor').setAttribute('visible', true);

    // Menü-Musik stoppen
    const menuMusicEntity = document.querySelector('#menuMusicEntity');
    if (menuMusicEntity && menuMusicEntity.components.sound) {
    menuMusicEntity.components.sound.stopSound();
    }

    cursorBase.object3D.visible = false;
    progressRing.object3D.visible = false;

    let room = document.querySelector(`#room-${videoId}`);
    if (!room) {
        room = document.createElement('a-entity');
        room.id = `room-${videoId}`;
        room.classList.add('room');
        const sphere = document.createElement('a-videosphere');
        sphere.setAttribute('src', `#video-${videoId}`);
        room.appendChild(sphere);

        // Musik einfügen (falls vorhanden)
        const musicEl = document.querySelector(`#music-${videoId}`);
        if (musicEl) {
        const soundEntity = document.createElement('a-entity');
        soundEntity.setAttribute('sound', `src: #music-${videoId}; autoplay: true; loop: true; volume: 0.5`);
        room.appendChild(soundEntity);
        }

        
        rooms.appendChild(room);
    } else {
        room.setAttribute('visible', 'true');
    }

    const videoEl = document.querySelector(`#video-${videoId}`);
    if (videoEl) videoEl.play().catch(err => console.warn('Video konnte nicht starten:', err));


// Hinweis-Container
const hintContainer = document.createElement('a-entity');
hintContainer.setAttribute('id', 'exitHint');
hintContainer.setAttribute('position', `0 0.5 -1.5`);
hintContainer.setAttribute('look-at', '#camera');

// Hintergrundfläche
const bg = document.createElement('a-plane');
bg.setAttribute('width', '2.4');
bg.setAttribute('height', '0.35');
bg.setAttribute('color', '#222222');
bg.setAttribute('opacity', '0.6');
bg.setAttribute('material', 'shader: flat');
bg.setAttribute('position', '0 0 0');
hintContainer.appendChild(bg);

// Hinweistext
const hintText = document.createElement('a-text');
hintText.setAttribute('value', 'Look 5 sek to the top, to get back to the menu');
hintText.setAttribute('align', 'center');
hintText.setAttribute('color', '#ffffff');
hintText.setAttribute('width', '2.2');
hintText.setAttribute('position', '0 0 0.01'); // leicht vor dem Hintergrund
hintText.setAttribute('baseline', 'center');
hintText.setAttribute('side', 'double');
hintContainer.appendChild(hintText);

// Füge den Hinweis als Kind des Kamera-Rigs hinzu
document.querySelector('#cameraRig').appendChild(hintContainer);

// Automatisch nach 4 Sekunden entfernen
setTimeout(() => {
  if (hintContainer && hintContainer.parentNode) {
    hintContainer.parentNode.removeChild(hintContainer);
  }
}, 4000);

    
}


// Return-Zone Fuse
let returnTimer = null;
returnZone.addEventListener('mouseenter', () => {
    // Cursor & Ring nur temporär sichtbar während Fuse
    cursorBase.object3D.visible = true;
    progressRing.object3D.visible = true;
    progressRing.setAttribute('animation__fill', 'property: theta-length; from:0; to:360; dur:5000; easing: linear');

    returnTimer = setTimeout(() => {
        showMenuState(); // Menü zurück → Cursor dauerhaft sichtbar
    }, 5000);
});

returnZone.addEventListener('mouseleave', () => {
    // Nach Fuse abbrechen: Cursor + Ring wieder unsichtbar im Raum
    progressRing.removeAttribute('animation__fill');
    progressRing.setAttribute('theta-length', 0);
    if (!menu.getAttribute('visible')) {
        cursorBase.object3D.visible = false;
        progressRing.object3D.visible = false;
    }
    clearTimeout(returnTimer);
});




// ---------------------------
// Szene geladen → Menü initialisieren
// ---------------------------

scene.addEventListener('loaded', () => {
    // kleine Verzögerung, damit camera.object3D.position korrekt ist
    setTimeout(() => {
        //initMenu();
        initMenu(testVideosSets[0]);
        document.getElementById('loading').style.display = 'none';
    }, 100); // 100ms reicht oft aus
});



</script>


    </body>
</html>